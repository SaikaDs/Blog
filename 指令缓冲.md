# 背景
开了个新坑，做一个传统的3DACT，其中输入缓冲是一个必不可少的机制。

**输入缓冲**允许系统在短时间内存储玩家的输入，然后在适当的时间执行这些输入。在格斗游戏中，这意味着玩家可以在第一个攻击动作执行期间提前输入第二个攻击的命令，系统将“记住”这个输入，并在第一个动作完成后立即执行第二个动作。

如果没有输入缓冲，玩家必须在一个动作完全结束后的瞬间精确地输入下一个动作的指令，否则指令就会丢失，造成不好的体验。

# 规划
在我的demo里，打算使用指令缓冲，即把玩家的输入抽象成指令对象，因为同一个指令可能由多个按键组成，方便扩展。

有以下几个指令
闪避、防御、攻击、技能1~技能4

需要应用缓冲的场景主要就是攻击、技能、闪避动作中的前摇（不可响应阶段）需要存储一下指令输入，并在后摇（可响应阶段）执行这些指令

# 实现
指令是跨状态的，例如闪避、攻击两个状态间需要共用同一个指令缓冲系统，因此指令队列需要实现在角色主要控制器脚本中，而不是状态机中。

主要机制如下：
1. 声明一个cmd类，cmd类型，cmd队列。
2. 各状态机自己实现可响应、不可响应阶段
3. 在各状态机中，收到输入时，如果处于可响应阶段，则直接执行动作
4. 如果处于不可响应阶段，则根据输入生成cmd对象，入队
5. 在各状态机的update中，更新可响应阶段，并判断如果处于可响应阶段，则检查cmd队列，用以下逻辑循环检查队列：
    1. 每次弹出一个指令，若可执行，根据该指令执行动作，然后break
    2. 若不可执行，继续循环
    3. 直到遇到第一个可执行的动作或队列为空

用这个机制可以做到：在当前状态下，即使玩家误输入了一些冗余指令，也不会影响后续的正确的指令的执行。例如在上一个攻击前摇中，玩家连续输入了一个技能和普通攻击，但当前蓝量或cd不满足，无法释放技能，但下一个普通攻击能接上。

# 改进计划
1. 由每个状态机监听自身相关的输入，并生成指令。例如，攻击状态只监听鼠标左键，生成攻击指令；闪避状态只监听shift，生成闪避指令。
2. 输入不直接响应，而是统统生成指令进入队列
3. 当前状态机在自身的update中，如果处于不可响应阶段，不做处理，处于可响应阶段，则检查cmd队列，用上面的逻辑进行动作执行

tips:
1. 每个状态，只有是当前状态时，才会被状态机调用update，从而读取指令队列，并根据当前状态的条件决定是否执行动作；
不是当前状态时，不会调用update，但仍会监听输入，并生成指令
2. 每个指令对象都拥有一个持续时间，默认为0.5s。指令队列会每帧更新指令的寿命，若指令超过0.5s还没得到执行则会被剔除

这样相同的指令生成代码，不用在多个状态机中写重复逻辑。按键、指令与状态一一对应，划分清晰明确
